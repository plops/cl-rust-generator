name: Release 19_webprox

on:
  push:
    tags:
      - 'webprox-v*'
    paths:
      - 'examples/19_webprox/**'
      - '.github/workflows/release-19-webprox.yml'
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect 19_webprox Changes
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.detect.outputs.should_build }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Decide whether to build
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual run requested; enabling build."
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git rev-parse "${GITHUB_SHA}^" >/dev/null 2>&1; then
            changed_files="$(git diff --name-only "${GITHUB_SHA}^" "${GITHUB_SHA}")"
          else
            changed_files="$(git show --pretty='' --name-only "${GITHUB_SHA}")"
          fi

          echo "Changed files in tagged commit:"
          echo "$changed_files"

          if echo "$changed_files" | grep -Eq '^(examples/19_webprox/|\.github/workflows/release-19-webprox\.yml$)'; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          fi

  validate-versions:
    name: Validate Tag vs Crate Versions
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate versions
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual run requested; skipping tag/version validation."
            exit 0
          fi

          tag="${GITHUB_REF_NAME}"
          if [[ ! "$tag" =~ ^webprox-v(.+)$ ]]; then
            echo "Tag '$tag' does not match required format 'webprox-v<version>'." >&2
            exit 1
          fi
          tag_version="${BASH_REMATCH[1]}"

          server_version="$(sed -n 's/^version = \"\\([^\"]*\\)\"/\\1/p' examples/19_webprox/cloud-proxy-server/Cargo.toml | head -n1)"
          client_version="$(sed -n 's/^version = \"\\([^\"]*\\)\"/\\1/p' examples/19_webprox/minimal-tui-client/Cargo.toml | head -n1)"

          if [ -z "$server_version" ] || [ -z "$client_version" ]; then
            echo "Failed to read crate version(s) from Cargo.toml." >&2
            exit 1
          fi

          echo "Tag version: $tag_version"
          echo "cloud-proxy-server version: $server_version"
          echo "minimal-tui-client version: $client_version"

          if [ "$tag_version" != "$server_version" ]; then
            echo "Tag version does not match cloud-proxy-server version." >&2
            exit 1
          fi

          if [ "$tag_version" != "$client_version" ]; then
            echo "Tag version does not match minimal-tui-client version." >&2
            exit 1
          fi

  build-and-release:
    name: Build and Release
    needs: [detect-changes, validate-versions]
    if: needs.detect-changes.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            asset_name: webprox-linux-amd64
            archive_ext: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            asset_name: webprox-macos-amd64
            archive_ext: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            asset_name: webprox-macos-arm64
            archive_ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            asset_name: webprox-windows-amd64
            archive_ext: zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            examples/19_webprox

      - name: Build workspace in release mode
        run: cargo build --manifest-path examples/19_webprox/Cargo.toml --workspace --release --target ${{ matrix.target }}

      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail

          BIN_DIR="examples/19_webprox/target/${{ matrix.target }}/release"
          ASSET="${{ matrix.asset_name }}.${{ matrix.archive_ext }}"

          bins=()
          for bin in cloud-proxy-server minimal-tui-client; do
            if [ -f "$BIN_DIR/$bin" ]; then
              bins+=("$bin")
            fi
          done

          if [ "${#bins[@]}" -eq 0 ]; then
            echo "No binaries found in $BIN_DIR" >&2
            exit 1
          fi

          tar czf "$ASSET" -C "$BIN_DIR" "${bins[@]}"

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $binDir = "examples/19_webprox/target/${{ matrix.target }}/release"
          $asset = "${{ matrix.asset_name }}.${{ matrix.archive_ext }}"

          $candidates = @("cloud-proxy-server.exe", "minimal-tui-client.exe")
          $files = @()
          foreach ($candidate in $candidates) {
            $path = Join-Path $binDir $candidate
            if (Test-Path $path) {
              $files += $path
            }
          }

          if ($files.Count -eq 0) {
            Write-Error "No binaries found in $binDir"
          }

          Compress-Archive -Path $files -DestinationPath $asset -Force

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ matrix.asset_name }}.${{ matrix.archive_ext }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
